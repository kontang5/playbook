---
- name: Server setup
  hosts: local
  gather_facts: true

  pre_tasks:
    - name: Check config.yml exists
      stat:
        path: "{{ playbook_dir }}/config.yml"
      register: config_file

    - name: Fail if config.yml is missing
      fail:
        msg: "config.yml not found. Copy config.yml.example to config.yml and update values."
      when: not config_file.stat.exists

  vars_files:
    - config.yml

  roles:
    - role: common
      tags: common
    - role: orbstack
      tags: orbstack
    - role: lmstudio
      tags: lmstudio
      when: enable_lmstudio | default(false)
    - role: jenkins
      tags: jenkins
    - role: nginx
      tags: nginx
    - role: postgresql
      tags: postgresql
    - role: redis
      tags: redis
      when: enable_redis | default(false)
    - role: observability
      tags: observability
