services:
  openobserve:
    image: public.ecr.aws/zinclabs/openobserve:latest
    container_name: openobserve
    environment:
      ZO_ROOT_USER_EMAIL: ${ZO_ROOT_USER_EMAIL}
      ZO_ROOT_USER_PASSWORD: ${ZO_ROOT_USER_PASSWORD}
      ZO_DATA_DIR: /data
      ZO_COMPACT_DATA_RETENTION_DAYS: 30
    volumes:
      - openobserve-data:/data
    ports:
      - "5080:5080"
    networks:
      - private
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    restart: unless-stopped

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    user: "0:0"
    command:
      - "--config=/etc/otel/base.yaml"
      - "--config=/etc/otel/docker.yaml"
      - "--config=/etc/otel/routing.yaml"
      - "--config=/etc/otel/application.yaml"
      - "--config=/etc/otel/nginx.yaml"
      - "--config=/etc/otel/database.yaml"
    environment:
      POSTGRES_OBSERVER_PASSWORD: ${POSTGRES_OBSERVER_PASSWORD}
      ZO_INGESTION_TOKEN: ${ZO_INGESTION_TOKEN}
    volumes:
      - ./otel-collector:/etc/otel:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - otel-file-storage:/var/lib/otelcol/file_storage
    ports:
      - "4317:4317"
      - "4318:4318"
      - "13133:13133"
    networks:
      - private
      - db
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    restart: unless-stopped

networks:
  private:
    external: true
    name: private-network
  db:
    external: true
    name: db-network

volumes:
  openobserve-data:
    external: true
    name: openobserve-data
  otel-file-storage:
