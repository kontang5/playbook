# Application telemetry: backend API logs, metrics, traces via OTLP

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  # Filter: drop auto-instrumentation duration metrics (keep custom ones)
  filter/metrics_drop:
    metrics:
      metric:
        - 'name == "http.client.duration"'
        - 'name == "http.server.duration"'

  # Transform: remove noisy resource attributes from metrics
  transform/metrics_cleanup:
    metric_statements:
      - context: resource
        statements:
          - delete_key(attributes, "process.command")
          - delete_key(attributes, "process.command_args")
          - delete_key(attributes, "process.executable.name")
          - delete_key(attributes, "process.executable.path")
          - delete_key(attributes, "process.owner")
          - delete_key(attributes, "process.pid")
          - delete_key(attributes, "process.runtime.description")
          - delete_key(attributes, "process.runtime.name")
          - delete_key(attributes, "process.runtime.version")
          - delete_key(attributes, "telemetry.sdk.language")
          - delete_key(attributes, "telemetry.sdk.name")
          - delete_key(attributes, "telemetry.sdk.version")

  # Transform: remove noisy resource attributes from traces
  transform/traces_cleanup:
    trace_statements:
      - context: resource
        statements:
          - delete_key(attributes, "process.command")
          - delete_key(attributes, "process.command_args")
          - delete_key(attributes, "process.executable.name")
          - delete_key(attributes, "process.executable.path")
          - delete_key(attributes, "process.owner")
          - delete_key(attributes, "process.pid")
          - delete_key(attributes, "process.runtime.description")
          - delete_key(attributes, "process.runtime.name")
          - delete_key(attributes, "process.runtime.version")
          - delete_key(attributes, "telemetry.sdk.language")
          - delete_key(attributes, "telemetry.sdk.name")
          - delete_key(attributes, "telemetry.sdk.version")

exporters:
  otlphttp/application:
    endpoint: http://openobserve:5080/api/default
    headers:
      Authorization: Basic ${ZO_INGESTION_TOKEN}
      stream-name: application
    tls:
      insecure: true

service:
  pipelines:
    # Application logs (via OTLP SDK)
    logs/application:
      receivers:
        - otlp
      processors:
        - memory_limiter
        - batch
        - resource
      exporters:
        - otlphttp/application

    # Application metrics (via OTLP SDK)
    metrics/application:
      receivers:
        - otlp
      processors:
        - memory_limiter
        - filter/metrics_drop
        - transform/metrics_cleanup
        - batch
        - resource
      exporters:
        - otlphttp/openobserve

    # Application traces
    traces:
      receivers:
        - otlp
      processors:
        - memory_limiter
        - transform/traces_cleanup
        - batch
        - resource
      exporters:
        - otlphttp/openobserve
