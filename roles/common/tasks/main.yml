---
- name: Install Homebrew packages
  homebrew:
    name: "{{ homebrew_packages }}"
    state: present

- name: Ensure .ssh directory exists
  file:
    path: "~/.ssh"
    state: directory
    mode: "0700"

- name: Generate SSH key
  openssh_keypair:
    path: "{{ ssh_key_path }}"
    type: "{{ ssh_key_type }}"
    mode: "0600"

- name: Configure SSH client
  blockinfile:
    path: "~/.ssh/config"
    create: yes
    mode: "0600"
    marker: "# {mark} ANSIBLE MANAGED BLOCK"
    block: "{{ ssh_config }}"

- name: Ensure authorized_keys exists
  file:
    path: "~/.ssh/authorized_keys"
    state: touch
    mode: "0600"

- name: Configure sshd
  become: yes
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?{{ item.key }}"
    line: "{{ item.key }} {{ item.value }}"
    backup: yes
  loop: "{{ sshd_config | dict2items }}"
  notify: Restart sshd
