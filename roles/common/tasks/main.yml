---
# Package Installation

- name: Install Homebrew packages
  homebrew:
    name: "{{ homebrew_packages }}"
    state: present

- name: Ensure .ssh directory exists
  file:
    path: "~/.ssh"
    state: directory
    mode: "0700"

- name: Generate SSH key
  openssh_keypair:
    path: "{{ ssh_key_path }}"
    type: "{{ ssh_key_type }}"
    mode: "0600"

- name: Configure SSH client
  blockinfile:
    path: "~/.ssh/config"
    create: yes
    mode: "0600"
    marker: "# {mark} ANSIBLE MANAGED BLOCK"
    block: "{{ ssh_config }}"

- name: Ensure authorized_keys exists
  file:
    path: "~/.ssh/authorized_keys"
    state: touch
    mode: "0600"
    access_time: preserve
    modification_time: preserve

- name: Enable Remote Login (SSH)
  become: yes
  command: systemsetup -setremotelogin on
  changed_when: false
  ignore_errors: true  # Requires Full Disk Access

- name: Configure sshd
  become: yes
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?{{ item.key }}"
    line: "{{ item.key }} {{ item.value }}"
    backup: yes
  loop: "{{ sshd_config | dict2items }}"
  notify: Restart sshd

# macOS Server Optimizations

- name: Disable Spotlight indexing
  become: yes
  command: mdutil -a -i off
  changed_when: false

- name: Disable App Nap
  command: defaults write NSGlobalDomain NSAppSleepDisabled -bool YES
  changed_when: false

- name: Reduce transparency
  command: defaults write com.apple.universalaccess reduceTransparency -bool true
  changed_when: false
  ignore_errors: true

- name: Disable sleep
  become: yes
  command: pmset -a sleep 0 displaysleep 0 disksleep 0
  changed_when: false

- name: Enable restart after power failure
  become: yes
  command: pmset -a autorestart 1
  changed_when: false

- name: Disable Siri
  command: defaults write com.apple.assistant.support "Assistant Enabled" -bool false
  changed_when: false
  ignore_errors: true

- name: Disable Time Machine
  become: yes
  command: tmutil disable
  changed_when: false

- name: Enable firewall
  become: yes
  command: /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on
  changed_when: false

- name: Disable AirDrop
  command: defaults write com.apple.NetworkBrowser DisableAirDrop -bool YES
  changed_when: false
  ignore_errors: true

- name: Disable Handoff
  command: defaults -currentHost write com.apple.coreservices.useractivityd ActivityAdvertisingAllowed -bool false
  changed_when: false
  ignore_errors: true

